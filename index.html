<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Angiopharm - Профессиональная косметика</title>
  <style>
    /* Анимация загрузки */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.5s ease-out;
    }
    .loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #595377;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    .loading-text {
      color: #595377;
      font-size: 16px;
      font-weight: 500;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Скрыть контент до загрузки */
    body.loading .wrap { opacity: 0; }
    body.loading .drawer { opacity: 0; }
    body.loading .modal-backdrop { opacity: 0; }
    
    /* Плавные переходы для всех элементов */
    * { transition: all 0.2s ease; }
    
    /* Улучшенные тени */
    .card:hover { box-shadow: 0 8px 25px rgba(89,83,119,0.15); }
    .drawer { box-shadow: -4px 0 20px rgba(0,0,0,0.1); }
    .modal { box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
    
    :root{
      --primary:#595377; --secondary:#A8A8A8; --bg:#fafbfc; --panel:#ffffff; 
      --text:#2d3748; --muted:#718096; --line:#e2e8f0; --accent:#595377;
      --danger:#e53e3e; --ok:#38a169; --radius:8px; 
      --shadow:0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-lg:0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    body{margin:0; font:16px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; color:var(--text); background:var(--bg)}
    
    /* Мобильная шапка */
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:blur(20px);
      background:rgba(255,255,255,0.95); border-bottom:1px solid var(--line);
    }
    .wrap{max-width:100%; margin:0; padding:12px 16px;}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .brand{display:flex; align-items:center; gap:8px; font-weight:600; font-size:18px; color:var(--text)}
    .brand img{height:28px; width:auto;}
    .spacer{flex:1}
    
    /* Мобильные кнопки */
    .cart-btn{display:inline-flex; align-items:center; gap:6px; padding:10px 14px; border-radius:var(--radius); 
              border:none; background:var(--primary); color:#fff; cursor:pointer; 
              font-weight:500; font-size:14px; transition:all 0.2s ease;}
    .cart-btn:hover{background:#4a4563; transform:translateY(-1px);}
    
    .login-btn{display:inline-flex; align-items:center; gap:6px; padding:10px 14px; border-radius:var(--radius); 
               border:1px solid var(--line); background:#fff; color:var(--text); cursor:pointer; 
               font-weight:500; font-size:14px; transition:all 0.2s ease;}
    .login-btn:hover{background:var(--bg); border-color:var(--secondary);}
    
    .badge{display:none; align-items:center; gap:6px; padding:6px 10px; border-radius:var(--radius); 
           background:var(--primary); color:#fff; font-size:12px; font-weight:500;}
    .logout-btn{display:none; padding:10px 14px; border-radius:var(--radius); border:1px solid var(--line); 
                background:#fff; color:var(--text); cursor:pointer; font-weight:500; font-size:14px; transition:all 0.2s ease;}
    .logout-btn:hover{background:var(--bg);}

    /* Мобильные фильтры */
    .filterbar{display:flex; flex-direction:column; gap:16px; padding:20px 0;}
    .search{position:relative;}
    .search input{
      width:100%; padding:14px 16px 14px 45px; border:1px solid var(--line); 
      border-radius:var(--radius); background:#fff; box-shadow:var(--shadow); 
      outline:none; font-size:16px; transition:all 0.2s ease;
    }
    .search input:focus{border-color:var(--primary); box-shadow:0 0 0 3px rgba(89,83,119,0.1);}
    .search .icon{position:absolute; left:12px; top:50%; transform:translateY(-50%); 
                  color:var(--secondary); font-size:18px;}
    .search .clear{position:absolute; right:12px; top:50%; transform:translateY(-50%); 
                   background:#fff; border:none; border-radius:50%; 
                   padding:4px; cursor:pointer; font-size:16px; color:var(--secondary);
                   transition:all 0.2s ease; width:24px; height:24px; display:flex; align-items:center; justify-content:center;}
    .search .clear:hover{background:var(--bg); color:var(--text);}
    
    .category-chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:16px;}
    .chip{border:1px solid var(--line); background:#fff; border-radius:20px; 
          padding:8px 12px; cursor:pointer; user-select:none; font-weight:500; font-size:13px;
          transition:all 0.2s ease; text-align:center; display:flex; align-items:center; gap:6px; min-height:36px;}
    .chip:hover{border-color:var(--primary); color:var(--primary); background:var(--bg); transform:translateY(-1px);}
    .chip.active{background:var(--primary); color:#fff; border-color:var(--primary);}
    .chip .count{opacity:0.7; font-size:11px; font-weight:600; background:rgba(255,255,255,0.2); 
                 padding:2px 6px; border-radius:10px;}
    .chip.active .count{background:rgba(255,255,255,0.3);}

    /* Мобильная сетка товаров */
    .grid{display:grid; grid-template-columns:1fr; gap:12px; padding:20px 0;}
    @media (min-width: 768px) {
      .grid{grid-template-columns:repeat(3, 1fr); gap:16px;}
    }
    @media (min-width: 1024px) {
      .grid{grid-template-columns:repeat(4, 1fr); gap:20px;}
    }
    
    .card{background:#fff; border:none; border-radius:var(--radius); 
          box-shadow:var(--shadow); display:flex; flex-direction:column; 
          transition:all 0.2s ease; overflow:hidden; position:relative;
          padding:16px; text-align:center;}
    .card:hover{transform:translateY(-2px); box-shadow:var(--shadow-lg);}
    
    .card img{width:100%; height:200px; object-fit:contain; background:#fff; margin-bottom:12px;}
    .card .body{padding:0;}
    .title{font-weight:600; margin:0 0 8px; font-size:14px; color:var(--text); 
           line-height:1.3; text-align:center;}
    .desc{display:none;} /* Скрываем описание */
    .price{margin:0; font-weight:600; font-size:16px; color:var(--primary); text-align:center;}
    .price .tag{display:inline-block; font-size:11px; font-weight:500; color:var(--primary); 
                background:#f7fafc; border:1px solid var(--line); padding:2px 8px; 
                border-radius:4px; margin-left:8px; vertical-align:middle;}
    
    .actions{display:flex; align-items:center; margin-top:12px;}
    
    button.primary{background:#595377; color:#fff; border:none; padding:8px 16px; 
                   border-radius:var(--radius); cursor:pointer; font-weight:500; font-size:13px;
                   transition:all 0.2s ease; width:100%; min-height:36px;}
    button.primary:hover{background:#4a4563; transform:translateY(-1px);}
    
    button.secondary{background:#fff; color:var(--text); border:1px solid var(--line); 
                     padding:8px 16px; border-radius:var(--radius); cursor:pointer; 
                     font-weight:500; font-size:13px; transition:all 0.2s ease; min-height:36px;}
    button.secondary:hover{background:var(--bg); border-color:var(--secondary);}
    
    .cart-btn, .login-btn, .logout-btn{padding:8px 16px; font-size:13px; min-height:36px;}

    /* Мобильная корзина - с правильной прокруткой */
    .drawer{position:fixed; right:0; top:0; bottom:0; width:100%; max-width:400px; 
            background:#fff; border-left:1px solid var(--line); transform:translateX(100%); 
            transition:all 0.3s ease; box-shadow:-4px 0 20px rgba(0,0,0,0.1); z-index:20; 
            display:flex; flex-direction:column;}
    .drawer.open{transform:translateX(0);}
    .drawer header{position:sticky; top:0; padding:16px; display:flex; align-items:center; gap:12px; 
                    background:#fff; border-bottom:1px solid var(--line); z-index:1; flex-shrink:0;}
    .drawer header strong{font-size:18px; color:var(--text); font-weight:600;}
    
    .cart-list{flex:1; padding:0; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch;}
    
    /* Блокировка скролла body когда корзина открыта */
    body.cart-open{overflow:hidden; position:fixed; width:100%; height:100%;}
    
    /* Мобильная оптимизация для клавиатуры */
    @media (max-width: 768px) {
      .drawer{
        height:100vh; 
        height:100dvh; /* Используем динамическую высоту viewport */
        max-height:100vh;
        max-height:100dvh;
      }
      .cart-footer{
        position:relative; 
        z-index:10;
        flex-shrink:0;
      }
      .checkout input, .checkout textarea{
        font-size:16px; /* Предотвращает зум на iOS */
        transform:translateZ(0); /* Принудительное аппаратное ускорение */
        -webkit-appearance:none; /* Убираем стили по умолчанию */
        border-radius:8px;
      }
      .checkout input:focus, .checkout textarea:focus{
        transform:translateZ(0) scale(1);
        outline:none;
        box-shadow:0 0 0 2px rgba(89,83,119,0.2);
      }
    }
    .cart-item{display:flex; gap:12px; padding:12px; border-bottom:1px solid #f0f0f0; 
               transition:background-color 0.2s ease;}
    .cart-item:hover{background:#fafbfc;}
    .cart-item img{width:60px; height:60px; object-fit:contain; background:#fff; 
                   border-radius:8px; border:1px solid #f0f0f0; flex-shrink:0;}
    .cart-item .details{flex:1; display:flex; flex-direction:column; gap:6px;}
    .cart-item .name{font-weight:600; font-size:14px; color:var(--text); line-height:1.3;}
    .cart-item .price{color:var(--primary); font-weight:600; font-size:14px;}
    .qty-controls{display:flex; align-items:center; gap:6px; margin-top:6px;}
    .qty-btn{width:28px; height:28px; border:1px solid #e0e0e0; background:#fff; 
             border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; 
             display:flex; align-items:center; justify-content:center; 
             transition:all 0.2s ease; color:#666;}
    .qty-btn:hover{background:#f5f5f5; border-color:var(--primary); color:var(--primary);}
    .qty-btn:active{transform:scale(0.95);}
    .qty-input{width:40px; text-align:center; border:1px solid #e0e0e0; 
               border-radius:6px; padding:4px; font-size:12px; font-weight:600;
               background:#fff; transition:border-color 0.2s ease;}
    .qty-input:focus{border-color:var(--primary); outline:none; box-shadow:0 0 0 2px rgba(89,83,119,0.1);}
    .remove-btn{width:28px; height:28px; border:1px solid #ff6b6b; background:#fff; 
                border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; 
                display:flex; align-items:center; justify-content:center; 
                transition:all 0.2s ease; color:#ff6b6b;}
    .remove-btn:hover{background:#ff6b6b; color:#fff;}
    .remove-btn:active{transform:scale(0.95);}
    
    .cart-footer{padding:16px; border-top:1px solid var(--line); background:#fafbfc;}
    .total{display:flex; justify-content:space-between; font-weight:600; margin:12px 0 16px; 
           font-size:18px; color:var(--text); padding:12px; background:#fff; border-radius:8px; 
           border:1px solid #f0f0f0;}
    .checkout{display:flex; flex-direction:column; gap:12px; padding:16px; border:none; 
              border-radius:8px; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,0.1);}
    .checkout input, .checkout textarea, .checkout select{width:100%; padding:10px; 
                                                          border:1px solid #e0e0e0; 
                                                          border-radius:6px; font-size:13px; 
                                                          transition:border-color 0.2s ease; background:#fff;
                                                          font-family:inherit;}
    .checkout input:focus, .checkout textarea:focus, .checkout select:focus{
      border-color:var(--primary); outline:none; box-shadow:0 0 0 2px rgba(89,83,119,0.1);}
    .checkout textarea{min-height:60px; resize:vertical; font-family:inherit;}
    .hint{font-size:11px; color:var(--muted); margin-top:4px;}
    .radio-row{display:flex; flex-direction:column; gap:8px;}
    .radio-row label{display:flex; align-items:center; gap:8px; cursor:pointer; 
                     font-weight:500; font-size:13px; padding:6px; border-radius:6px;
                     transition:background-color 0.2s ease;}
    .radio-row label:hover{background:#f5f5f5;}
    .radio-row input[type="radio"]{margin:0; width:16px; height:16px; accent-color:var(--primary);}
    .ok{color:var(--ok); font-weight:500;} 
    .err{color:var(--danger); font-weight:500;}
    .empty{padding:40px; text-align:center; color:var(--muted); font-size:15px;}

    /* Мобильные модальные окна */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; 
                    align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(8px);}
    .modal{width:90vw; max-width:400px; background:#fff; border-radius:var(--radius); 
           box-shadow:var(--shadow-lg); padding:24px; border:none;}
    .modal h3{margin:0 0 20px; font-size:20px; color:var(--text); font-weight:600;}
    .modal .row{margin-bottom:16px;}
    .modal input{width:100%; padding:12px; border:1px solid var(--line); border-radius:var(--radius); 
                 font-size:14px; transition:border-color 0.2s ease;}
    .modal input:focus{border-color:var(--primary); outline:none; box-shadow:0 0 0 3px rgba(89,83,119,0.1);}
    .modal .actions{display:flex; gap:12px; justify-content:flex-end; margin-top:20px; flex-wrap:wrap;}
    .pill{border-radius:var(--radius); padding:10px 16px; border:1px solid var(--line); 
          background:#fff; cursor:pointer; font-weight:500; font-size:14px; transition:all 0.2s ease;}
    .pill:hover{transform:translateY(-1px);}
    .pill.primary{background:var(--primary); color:#fff; border-color:var(--primary);}
    .pill.primary:hover{background:#4a4563;}
    .pill.ghost{background:#f7fafc; color:var(--primary); border-color:var(--primary);}
    .pill.gray{background:var(--secondary); color:#fff; border-color:var(--secondary);}

    .toast{position:fixed; right:16px; bottom:16px; background:var(--primary); color:#fff; 
           padding:12px 16px; border-radius:var(--radius); opacity:0.95; display:none; 
           z-index:10000; font-weight:500; box-shadow:var(--shadow-lg); 
           max-width:300px; animation:slideIn 0.3s ease;}
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 0.95; }
    }

    /* Мобильный футер */
    footer{background:var(--text); color:#fff; padding:32px 0; margin-top:60px;}
    .footer-content{max-width:100%; margin:0; padding:0 16px; text-align:center;}
    .footer-logo{display:flex; align-items:center; justify-content:center; gap:12px; 
                 margin-bottom:20px; font-size:18px; font-weight:600;}
    .footer-logo img{height:28px; width:auto;}
    .footer-info{display:grid; grid-template-columns:1fr; gap:20px; margin:20px 0;}
    .footer-section h4{font-size:16px; margin-bottom:12px; color:#fff; font-weight:600;}
    .footer-section p, .footer-section a{color:#a0aec0; text-decoration:none; 
                                         line-height:1.6; margin-bottom:6px; font-size:14px;}
    .footer-section a:hover{color:#fff;}
    .footer-bottom{border-top:1px solid rgba(255,255,255,0.1); padding-top:16px; 
                   margin-top:20px; color:#a0aec0; font-size:13px;}
    
    @media (min-width: 768px) {
      .footer-info{grid-template-columns:repeat(3, 1fr); gap:24px;}
      .footer-content{padding:0 20px;}
      footer{padding:40px 0; margin-top:80px;}
    }

    /* Минималистичные модальные окна */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; 
                    align-items:center; justify-content:center; z-index:9999; backdrop-filter:blur(8px);}
    .modal{width:400px; max-width:95vw; background:#fff; border-radius:var(--radius); 
           box-shadow:var(--shadow-lg); padding:24px; border:none; animation:modalSlideIn 0.3s ease;}
    .modal h3{margin:0 0 20px; font-size:20px; color:var(--text); font-weight:600;}
    .modal .row{margin-bottom:16px;}
    .modal input{width:100%; padding:12px; border:1px solid var(--line); border-radius:var(--radius); 
                 font-size:14px; transition:border-color 0.2s ease;}
    .modal input:focus{border-color:var(--primary); outline:none; box-shadow:0 0 0 3px rgba(89,83,119,0.1);}
    .modal .actions{display:flex; gap:12px; justify-content:flex-end; margin-top:20px; flex-wrap:wrap;}
    .pill{border-radius:var(--radius); padding:10px 16px; border:1px solid var(--line); 
          background:#fff; cursor:pointer; font-weight:500; font-size:14px; transition:all 0.2s ease;}
    .pill:hover{transform:translateY(-1px);}
    .pill.primary{background:var(--primary); color:#fff; border-color:var(--primary);}
    .pill.primary:hover{background:#4a4563;}
    .pill.ghost{background:#f7fafc; color:var(--primary); border-color:var(--primary);}
    .pill.gray{background:var(--secondary); color:#fff; border-color:var(--secondary);}

    .toast{position:fixed; right:20px; bottom:20px; background:var(--primary); color:#fff; 
           padding:12px 16px; border-radius:var(--radius); opacity:0.95; display:none; 
           z-index:10000; font-weight:500; box-shadow:var(--shadow-lg); 
           max-width:300px; animation:slideIn 0.3s ease;}
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 0.95; }
    }
    
    @keyframes modalSlideIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    /* Минималистичный футер */
    footer{background:#f8f9fa; border-top:1px solid var(--line); margin-top:60px; padding:24px 0;}
    .footer-content{max-width:1200px; margin:0 auto; padding:0 16px; text-align:center;}
    .footer-logo{display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:16px;}
    .footer-logo img{height:24px; width:auto;}
    .footer-bottom{color:var(--muted); font-size:12px; margin-top:16px;}
  </style>
</head>
<body class="loading">
  <!-- Экран загрузки -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <div class="loading-text">Загрузка...</div>
  </div>

  <header>
    <div class="wrap row">
      <div class="brand">
        <img src="https://angiopharm.com/catalog/view/theme/tt_artfurniture2/image/logo.svg" alt="Angiopharm" />
        
      </div>
      <div class="spacer"></div>

      <!-- Кнопка входа и статус роли -->
      <button class="login-btn" id="btnCosmoLogin">Вход для косметолога</button>
      <div class="badge" id="cosmoStatus">Косметолог</div>
      <button class="logout-btn" id="btnCosmoLogout">Выйти</button>

      <button class="cart-btn" id="openCart">🛒 <span id="cartCount">0</span></button>
    </div>
  </header>

  <main class="wrap">
    <!-- Фильтры: поиск + категории -->
    <div class="filterbar">
      <div class="search">
        <span class="icon"></span>
        <input id="searchInput" placeholder="Поиск по названию или описанию…" />
        <button id="searchClear" class="clear" title="Очистить">×</button>
      </div>
      <div id="categoryChips" class="category-chips"></div>
    </div>

    <div id="grid" class="grid"></div>
  </main>

  <aside class="drawer" id="drawer">
    <header>
      <strong>Корзина</strong>
      <div class="spacer"></div>
      <button class="secondary" id="closeCart">Закрыть</button>
    </header>
    <div class="cart-list" id="cartList"></div>
    <div class="cart-footer">
      <div class="total"><span>Итого</span><span id="total">0</span></div>
      <div class="checkout">
        <input id="name" placeholder="Имя" />
        <input id="phone" placeholder="Телефон" />
        <textarea id="note" placeholder="Комментарий (необязательно)"></textarea>
        <div class="radio-row">
          <label><input type="radio" name="pm" value="cash_on_delivery" checked> Оплата при получении</label>
          <label><input type="radio" name="pm" value="prepaid"> Онлайн-оплата (приложить чек)</label>
        </div>
        <div id="receiptWrap" style="display:none">
          <input type="file" id="receipt" accept="image/*,application/pdf" />
          <div class="hint">Прикрепите скрин/фото чека</div>
        </div>
        <button class="primary" id="submitOrder">Оформить заказ</button>
        <div id="msg" class="hint"></div>
      </div>
    </div>
  </aside>

  <!-- Модалка входа косметолога -->
  <div class="modal-backdrop" id="cosmoModal">
    <div class="modal">
      <h3>Вход для косметолога</h3>
      <div class="row">
        <input id="cosmoLogin" placeholder="Логин" />
      </div>
      <div class="row">
        <input id="cosmoPass" placeholder="Пароль" type="password" />
      </div>
      <div class="actions">
        <button class="pill gray" id="cosmoRegister">Зарегистрироваться</button>
        <button class="pill" id="cosmoCancel">Отмена</button>
        <button class="pill primary" id="cosmoDoLogin">Войти</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Футер сайта -->
  <footer>
    <div class="footer-content">
      <div class="footer-logo">
        <img src="https://angiopharm.com/catalog/view/theme/tt_artfurniture2/image/logo.svg" alt="Angiopharm" />
      </div>
      <div class="footer-bottom">
        <p>&copy; 2024 Angiopharm. Все права защищены.</p>
      </div>
    </div>
  </footer>

  <script>
    // === ВСТАВЬ свой /exec:
    const API_BASE = 'https://script.google.com/macros/s/AKfycbxuWdDv2ZGPSy2S_KC3FQtiWBexcVQND0zlMFh2C9IniafdsiNoMcR6uyPE1In8fLm_/exec';

    const LS_CART = 'market_cart_v1';
    const LS_TOKEN = 'market_token';
    const LS_ROLE  = 'market_role';
    const LS_NAME  = 'market_name';

    const grid = document.getElementById('grid');
    const drawer = document.getElementById('drawer');
    const cartList = document.getElementById('cartList');
    const openCartBtn = document.getElementById('openCart');
    const closeCartBtn = document.getElementById('closeCart');
    const totalEl = document.getElementById('total');
    const cartCountEl = document.getElementById('cartCount');
    const nameEl = document.getElementById('name');
    const phoneEl = document.getElementById('phone');
    const noteEl = document.getElementById('note');
    const receiptWrap = document.getElementById('receiptWrap');
    const receiptEl = document.getElementById('receipt');
    const msgEl = document.getElementById('msg');

    // Фильтры
    const categoryChips = document.getElementById('categoryChips');
    const searchInput = document.getElementById('searchInput');
    const searchClear = document.getElementById('searchClear');

    const btnCosmoLogin = document.getElementById('btnCosmoLogin');
    const btnCosmoLogout = document.getElementById('btnCosmoLogout');
    const cosmoStatus = document.getElementById('cosmoStatus');
    const cosmoModal = document.getElementById('cosmoModal');
    const cosmoLogin = document.getElementById('cosmoLogin');
    const cosmoPass  = document.getElementById('cosmoPass');
    const cosmoDoLogin = document.getElementById('cosmoDoLogin');
    const cosmoCancel  = document.getElementById('cosmoCancel');
    const cosmoRegister = document.getElementById('cosmoRegister');

    // Данные каталога в памяти
    let allProducts = [];
    let activeCategory = 'Все';
    let searchQuery = '';

    function toast(msg){
      const t = document.getElementById('toast');
      if(t) {
      t.textContent = msg; t.style.display = 'block';
      setTimeout(()=> t.style.display='none', 2500);
      }
    }

    function fmtMoney(n, cur='TJS'){
      try{ return new Intl.NumberFormat('ru-RU',{style:'currency',currency:cur}).format(n); }
      catch(_){ return (Number(n).toFixed(2) + ' р.'); }
    }

    // ========== ПРОСТАЯ И НАДЕЖНАЯ СИСТЕМА КОРЗИНЫ ==========
    
    let cart = [];
    
    function loadCart() {
      try {
        const saved = localStorage.getItem(LS_CART);
        cart = saved ? JSON.parse(saved) : [];
      } catch (e) {
        cart = [];
      }
      updateCartDisplay();
    }
    
    function saveCart() {
      try {
        localStorage.setItem(LS_CART, JSON.stringify(cart));
        updateCartDisplay();
      } catch (e) {
        console.error('Error saving cart:', e);
      }
    }
    
    function addToCart(product, quantity = 1) {
      // Преобразуем product.id в строку для надежного сравнения
      const stringId = String(product.id);
      const existingItem = cart.find(item => String(item.id) === stringId);
      
      if (existingItem) {
        existingItem.qty += quantity;
      } else {
        cart.push({
          id: product.id, // Сохраняем оригинальный ID (может быть строкой или числом)
          name: product.name,
          price: product.price,
          currency: product.currency || 'TJS',
          photo: product.photo || '',
          qty: quantity
        });
      }
      
      saveCart();
      drawer.classList.add('open');
      document.body.classList.add('cart-open');
    }

    function updateQuantity(itemId, newQty) {
      // Преобразуем itemId в строку для надежного сравнения
      const stringId = String(itemId);
      const item = cart.find(item => String(item.id) === stringId);
      if (item) {
        item.qty = Math.max(1, parseInt(newQty) || 1);
        saveCart();
      }
    }
    
    function removeItem(itemId) {
      // Преобразуем itemId в строку для надежного сравнения
      const stringId = String(itemId);
      cart = cart.filter(item => String(item.id) !== stringId);
      saveCart();
    }
    
    function clearCart() {
      cart = [];
      saveCart();
    }
    
    function getTotal() {
      return cart.reduce((total, item) => total + (item.price * item.qty), 0);
    }
    
    function getTotalItems() {
      return cart.reduce((total, item) => total + item.qty, 0);
    }
    
    function updateCartDisplay() {
      // Обновляем счетчик в шапке
      cartCountEl.textContent = getTotalItems();
      
      // Обновляем содержимое корзины
      if (cart.length === 0) {
        cartList.innerHTML = '<div class="empty">Корзина пуста</div>';
        totalEl.textContent = '0 TJS';
        return;
      }
      
      cartList.innerHTML = cart.map(item => `
        <div class="cart-item" data-id="${item.id}">
          <img src="${item.photo}" alt="${item.name}" />
          <div class="details">
            <div class="name">${item.name}</div>
            <div class="price">${fmtMoney(item.price, item.currency)}</div>
            <div class="qty-controls">
              <button class="qty-btn minus" onclick="updateQuantity('${item.id}', ${item.qty - 1})">-</button>
              <input type="number" value="${item.qty}" min="1" class="qty-input" 
                     onchange="updateQuantity('${item.id}', this.value)" />
              <button class="qty-btn plus" onclick="updateQuantity('${item.id}', ${item.qty + 1})">+</button>
              <button class="remove-btn" onclick="removeItem('${item.id}')">×</button>
          </div>
          </div>
        </div>
      `).join('');
      
      totalEl.textContent = fmtMoney(getTotal(), 'TJS');
    }
    
    // Глобальные функции для совместимости
    window.addToCart = addToCart;
    window.updateQuantity = updateQuantity;
    window.removeItem = removeItem;
    window.clearCart = clearCart;
    window.getCart = () => cart;
    window.setCart = (newCart) => {
      cart = newCart;
      saveCart();
    };
    
    // ========== КОНЕЦ СИСТЕМЫ КОРЗИНЫ ==========

    function phoneValid(p){ return /^[+]?[-()\d\s]{7,}$/.test(String(p||'').trim()); }

    async function fileToBase64(file){
      if (!file) return '';
      const buf = await file.arrayBuffer();
      let b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
      return `data:${file.type||'application/octet-stream'};base64,` + b64;
    }

    async function submitOrder(){
      const name = nameEl.value.trim();
      const phone = phoneEl.value.trim();
      const note = noteEl.value.trim();
      const pm = (document.querySelector('input[name="pm"]:checked')?.value)||'cash_on_delivery';
      if (!name) return msg('Укажите имя', true);
      if (!phoneValid(phone)) return msg('Укажите корректный телефон', true);
      if (cart.length===0) return msg('Корзина пуста', true);

      msg('Отправляем заказ…');
      try{
        let receipt_b64 = '';
        if (pm === 'prepaid' && receiptEl.files?.[0]) receipt_b64 = await fileToBase64(receiptEl.files[0]);

        const token = localStorage.getItem(LS_TOKEN) || '';
        const payload = {
          token, name, phone, note,
          payment_method: pm,
          cart: cart.map(x=>({id:x.id, qty:x.qty})),
          receipt_base64: receipt_b64
        };

        const res = await fetch(API_BASE + '?page=createorder', {
          method:'POST',
          headers:{ 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.ok){
          msg(`Заказ оформлен! № ${data.order_id}. Сумма: ${new Intl.NumberFormat('ru-RU').format(data.total)}.`);
          clearCart(); // Очищаем корзину
          receiptEl.value = '';
          // Закрываем корзину после успешного заказа
          drawer.classList.remove('open');
          document.body.classList.remove('cart-open');
        } else {
          msg('Ошибка: ' + (data.error||'Неизвестно'), true);
        }
      }catch(err){
        msg('Сеть/сервер: ' + err.message, true);
      }
    }

    function msg(t, err){ msgEl.textContent = t; msgEl.className = 'hint ' + (err?'err':'ok'); }

    // ---------- INIT ----------
    // Анимация загрузки
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.body.classList.remove('loading');
        const loadingScreen = document.getElementById('loadingScreen');
        loadingScreen.classList.add('hidden');
        setTimeout(() => {
          loadingScreen.style.display = 'none';
        }, 500);
      }, 1000); // Минимальное время показа загрузки
    });

    openCartBtn.onclick = ()=> {
      drawer.classList.add('open');
      document.body.classList.add('cart-open');
    };
    closeCartBtn.onclick = ()=> {
      drawer.classList.remove('open');
      document.body.classList.remove('cart-open');
    };
    
    // Закрытие корзины при клике вне её области
    drawer.addEventListener('click', (e) => {
      if (e.target === drawer) {
        drawer.classList.remove('open');
        document.body.classList.remove('cart-open');
      }
    });
    
    // Автоматическая прокрутка к полям ввода на мобильных устройствах
    function scrollToInput(inputElement) {
      if (window.innerWidth <= 768) {
        setTimeout(() => {
          const drawer = document.getElementById('drawer');
          const cartFooter = drawer.querySelector('.cart-footer');
          if (cartFooter) {
            cartFooter.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'end',
              inline: 'nearest'
            });
          }
        }, 300); // Небольшая задержка для появления клавиатуры
      }
    }
    
    // Добавляем обработчики фокуса для полей ввода
    nameEl.addEventListener('focus', () => scrollToInput(nameEl));
    phoneEl.addEventListener('focus', () => scrollToInput(phoneEl));
    noteEl.addEventListener('focus', () => scrollToInput(noteEl));
    
    // Обработчик изменения размера viewport (для клавиатуры)
    let initialViewportHeight = window.innerHeight;
    window.addEventListener('resize', () => {
      const currentHeight = window.innerHeight;
      if (currentHeight < initialViewportHeight * 0.75 && drawer.classList.contains('open')) {
        // Клавиатура открыта, корректируем высоту корзины
        const drawer = document.getElementById('drawer');
        drawer.style.height = currentHeight + 'px';
      } else if (currentHeight >= initialViewportHeight * 0.75) {
        // Клавиатура закрыта, восстанавливаем высоту
        const drawer = document.getElementById('drawer');
        drawer.style.height = '';
      }
    });
    document.getElementById('submitOrder').onclick = submitOrder;

    document.querySelectorAll('input[name="pm"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        receiptWrap.style.display = (document.querySelector('input[name="pm"]:checked')?.value === 'prepaid') ? '' : 'none';
      });
    });

    // ---------- РОЛИ / АВТОРИЗАЦИЯ ----------
    function setCosmoUI(role, name){
      if (role === 'cosmetologist'){
        cosmoStatus.textContent = 'Косметолог' + (name? ' — ' + name : '');
        cosmoStatus.style.display = 'inline-flex';
        btnCosmoLogout.style.display = 'inline-block';
        btnCosmoLogin.style.display = 'none';
      } else {
        cosmoStatus.style.display = 'none';
        btnCosmoLogout.style.display = 'none';
        btnCosmoLogin.style.display = 'inline-block';
      }
    }

    btnCosmoLogin.addEventListener('click', ()=> { cosmoModal.style.display='flex'; setTimeout(()=>cosmoLogin.focus(), 50); });
    cosmoCancel.addEventListener('click', ()=> { cosmoModal.style.display='none'; });

    cosmoRegister.addEventListener('click', ()=> {
      toast('Регистрация пока недоступна. Свяжитесь с администратором.');
    });

    btnCosmoLogout.addEventListener('click', ()=>{
      localStorage.removeItem(LS_TOKEN);
      localStorage.removeItem(LS_ROLE);
      localStorage.removeItem(LS_NAME);
      clearCart(); // Очищаем корзину
      setCosmoUI('guest','');
      toast('Вы вышли');
      loadProducts();
    });

    cosmoDoLogin.addEventListener('click', doLogin);
    cosmoPass.addEventListener('keydown', (e)=>{ if (e.key==='Enter') doLogin(); });

    async function doLogin(){
      const login = (cosmoLogin.value||'').trim();
      const password = (cosmoPass.value||'').trim();
      if (!login || !password){ toast('Введите логин и пароль'); return; }
      try{
        const res = await fetch(API_BASE+'?page=login', {
          method:'POST',
          headers:{'Content-Type':'text/plain;charset=utf-8'},
          body: JSON.stringify({ login, password })
        });
        const data = await res.json();
        if (!data.ok){ toast(data.error || 'Ошибка входа'); return; }
        localStorage.setItem(LS_TOKEN, data.token);
        localStorage.setItem(LS_ROLE,  data.role||'user');
        localStorage.setItem(LS_NAME,  data.name||'');
        setCosmoUI(data.role, data.name);
        cosmoModal.style.display='none';
        toast('Вход выполнен');
        loadProducts();
      }catch(e){
        toast('Сеть: '+e.message);
      }
    }

    // ---------- ФИЛЬТРЫ (категории + поиск) ----------
    function buildCategories(products){
      const counts = {};
      for (const p of products){
        const cat = (p.category || '').trim() || 'Без категории';
        counts[cat] = (counts[cat]||0) + 1;
      }
      const cats = Object.keys(counts).sort((a,b)=> a.localeCompare(b, 'ru'));
      return {counts, cats};
    }

    function renderCategoryChips(){
      const {counts, cats} = buildCategories(allProducts);
      const allCount = allProducts.length;
      const items = ['Все', ...cats];
      categoryChips.innerHTML = items.map(cat=>{
        const cnt = (cat==='Все') ? allCount : (counts[cat]||0);
        const active = (activeCategory===cat) ? 'active' : '';
        return `<div class="chip ${active}" data-cat="${cat}">${cat}<span class="count">${cnt}</span></div>`;
      }).join('');
      // Навесим обработчики
      categoryChips.querySelectorAll('.chip').forEach(ch=>{
        ch.addEventListener('click', ()=>{
          activeCategory = ch.getAttribute('data-cat');
          // переключить актив
          categoryChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
          ch.classList.add('active');
          applyFiltersAndRender();
        });
      });
    }

    function applyFiltersAndRender(){
      const q = searchQuery.trim().toLowerCase();
      const list = allProducts.filter(p=>{
        const byCat = (activeCategory==='Все') ? true :
          ((p.category || 'Без категории') === activeCategory);
        const bySearch = !q ? true :
          (String(p.name||'').toLowerCase().includes(q) || String(p.desc||'').toLowerCase().includes(q));
        return byCat && bySearch;
      });
      renderGrid(list);
    }

    function renderGrid(list){
      if (!list || list.length===0){
        grid.innerHTML = '<div class="empty">Ничего не найдено</div>';
        return;
      }
      grid.innerHTML = list.map(p=>{
        const priceTag = (p.price_type === 'cosmo') ? '<span class="tag">для косметолога</span>' : '';
        return `
        <div class="card" data-product-id="${p.id}">
          <img src="${p.photo||''}" alt="${p.name}" />
          <div class="body">
            <div class="title">${p.name}</div>
            <div class="price">${fmtMoney(p.price, p.currency||'TJS')} ${priceTag}</div>
            <div class="actions">
              <button class="primary" onclick="addToCart(allProducts.find(product => product.id === '${p.id}'), 1)">Добавить в корзину</button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    // ---------- КАТАЛОГ ----------
    async function loadProducts(){
      grid.innerHTML = '<div class="empty">Загрузка…</div>';
      try{
        const token = localStorage.getItem(LS_TOKEN) || '';
        const url = API_BASE + '?page=products' + (token?('&token='+encodeURIComponent(token)):'');
        const res = await fetch(url);
        const data = await res.json();
        if (!data.ok) throw new Error(data.error||'Ответ сервера без ok');

        const arr = data.data||[];
        // нормализуем структуру под рендер (цена уже effective)
        allProducts = arr.map(p=>{
          const effective = (typeof p.effective_price === 'number' && !isNaN(p.effective_price)) ? p.effective_price : (p.price||0);
          return {
            id: p.id,
            name: p.name,
            desc: p.desc||'',
            currency: p.currency || 'TJS',
            photo: p.photo||'',
            category: (p.category||'').trim() || 'Без категории',
            price: effective,
            price_type: p.price_type || 'retail'
          };
        });

        // восстановим/сбросим активную категорию, если её уже нет
        const {cats} = buildCategories(allProducts);
        if (activeCategory!=='Все' && !cats.includes(activeCategory)) activeCategory = 'Все';

        renderCategoryChips();
        applyFiltersAndRender();
      }catch(err){
        grid.innerHTML = '<div class="empty">Не удалось загрузить каталог: ' + err.message + '</div>';
      }
    }

    // Поиск с дебаунсом
    let searchT = null;
    searchInput.addEventListener('input', ()=>{
      if (searchT) clearTimeout(searchT);
      searchT = setTimeout(()=>{
        searchQuery = searchInput.value || '';
        applyFiltersAndRender();
      }, 200);
    });
    searchClear.addEventListener('click', ()=>{
      searchInput.value = '';
      searchQuery = '';
      applyFiltersAndRender();
      searchInput.focus();
    });

    // ---------- INIT ----------
    // Восстановить статус роли в шапке
    (function initRole(){
      const role = localStorage.getItem(LS_ROLE) || 'guest';
      const name = localStorage.getItem(LS_NAME) || '';
      setCosmoUI(role, name);
    })();

    // Инициализация корзины
    loadCart();

    loadProducts();





  </script>
</body>
</html>
